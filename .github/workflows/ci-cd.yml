name: QuickShare CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [master, main, develop]
  schedule:
    - cron: "0 0 * * *"

jobs:
  # ============================================
  # JOB 1: EXTENSION VALIDATION
  # ============================================
  validate-extension:
    runs-on: ubuntu-latest
    name: ğŸ“‹ Validate Extension Structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: âœ… Check manifest.json exists
        run: |
          if [ ! -f manifest.json ]; then
            echo "âŒ manifest.json not found!"
            exit 1
          fi
          echo "âœ… manifest.json found"

      - name: âœ… Validate manifest.json (JSON syntax)
        run: |
          python3 -m json.tool manifest.json > /dev/null
          echo "âœ… manifest.json is valid JSON"

      - name: âœ… Check required files
        run: |
          required_files=("popup.html" "popup.js" "popup.css" "qrcode.min.js" "README.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
            echo "âœ… Found $file"
          done

      - name: âœ… Check required icons
        run: |
          icons=("icon16.png" "icon48.png" "icon128.png")
          for icon in "${icons[@]}"; do
            if [ ! -f "$icon" ]; then
              echo "âŒ Required icon missing: $icon"
              exit 1
            fi
            echo "âœ… Found $icon ($(du -h $icon | cut -f1))"
          done

      - name: âœ… Verify manifest references
        run: |
          echo "âœ… Checking manifest references..."
          if grep -q '"popup": "popup.html"' manifest.json || grep -q '"default_popup": "popup.html"' manifest.json; then
            echo "âœ… popup.html referenced in manifest"
          fi

      - name: âœ… Check manifest version
        run: |
          version=$(python3 -c "import json; f=open('manifest.json'); d=json.load(f); print(d.get('version', 'NOT_FOUND'))")
          echo "Version: $version"
          if [ "$version" = "NOT_FOUND" ]; then
            echo "âŒ Version not found in manifest"
            exit 1
          fi
          echo "âœ… Version check passed"

  # ============================================
  # JOB 2: CODE QUALITY CHECK
  # ============================================
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ” Code Quality Check
    needs: validate-extension

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: âœ… JavaScript Syntax Check
        run: |
          echo "âœ… Checking JavaScript files..."
          for file in popup.js; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              node -c "$file" && echo "âœ… $file syntax OK" || exit 1
            fi
          done

      - name: âœ… Check CSS structure
        run: |
          if [ -f popup.css ]; then
            echo "âœ… CSS file found"
            lines=$(wc -l < popup.css)
            echo "  - Lines: $lines"
            echo "âœ… CSS structure OK"
          fi

      - name: âœ… Check HTML validity
        run: |
          if [ -f popup.html ]; then
            echo "âœ… HTML file found"
            lines=$(wc -l < popup.html)
            echo "  - Lines: $lines"
            echo "âœ… HTML structure OK"
          fi

      - name: âš ï¸ Check for debug statements
        run: |
          echo "Checking for debug statements..."
          if grep -n "console\.log" popup.js 2>/dev/null | head -5; then
            echo "âš ï¸ Found console.log (remove for production)"
          else
            echo "âœ… No console.log found"
          fi

      - name: âš ï¸ Check for potential issues
        run: |
          echo "Checking for common issues..."
          if grep -r "eval(" *.js 2>/dev/null; then
            echo "âš ï¸ Found eval() - consider removing"
          else
            echo "âœ… No eval() found"
          fi

  # ============================================
  # JOB 3: SECURITY CHECKS
  # ============================================
  security-checks:
    runs-on: ubuntu-latest
    name: ğŸ” Security Checks
    needs: validate-extension

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”’ Scan for exposed secrets
        run: |
          echo "Scanning for exposed secrets..."
          if grep -r "api_key\|API_KEY\|private.*key\|password" *.js *.html 2>/dev/null | grep -v "// " | grep -v "<!-- "; then
            echo "âš ï¸ Found potential secrets"
          else
            echo "âœ… No obvious secrets found"
          fi

      - name: ğŸ”’ Check for vulnerable patterns
        run: |
          echo "Checking for vulnerable patterns..."

          if grep -r "eval(" *.js 2>/dev/null; then
            echo "âš ï¸ Found eval() usage"
          else
            echo "âœ… No eval() found"
          fi

          if grep -r "innerHTML\s*=" *.js 2>/dev/null | grep -v "//"; then
            echo "âš ï¸ Found innerHTML assignment - ensure input sanitized"
          else
            echo "âœ… No unsafe innerHTML found"
          fi

      - name: ğŸ”’ Verify dependencies
        run: |
          echo "Verifying dependencies..."

          if [ -f qrcode.min.js ]; then
            size=$(du -h qrcode.min.js | cut -f1)
            echo "âœ… QRCode library present ($size)"
          else
            echo "âŒ QRCode library missing"
            exit 1
          fi

      - name: ğŸ”’ Check extension permissions
        run: |
          echo "Verifying extension permissions..."
          echo "Declared permissions:"
          grep -A 3 '"permissions"' manifest.json
          echo "âœ… Permission check complete"

      - name: ğŸ”’ Check CSP directives
        run: |
          if grep -q "unsafe-eval\|unsafe-inline" manifest.json; then
            echo "âš ï¸ Warning: Uses unsafe CSP directives"
          else
            echo "âœ… No unsafe CSP directives found"
          fi

  # ============================================
  # JOB 4: CREATE RELEASE (only on tags)
  # ============================================
  create-release:
    runs-on: ubuntu-latest
    name: ğŸš€ Create Release
    needs: [validate-extension, code-quality, security-checks]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ğŸ“¦ Extract version from tag
        id: tag_name
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: ğŸ“‹ Get recent commits for changelog
        id: changelog
        run: |
          CHANGELOG=$(git log --oneline -10)
          {
            echo "CHANGELOG<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Create extension package
        run: |
          mkdir -p release
          zip -r release/quickshare-${{ steps.tag_name.outputs.VERSION }}.zip \
            manifest.json \
            popup.html \
            popup.js \
            popup.css \
            qrcode.min.js \
            icon16.png \
            icon48.png \
            icon128.png \
            README.md \
            QUICKSTART.md

          echo "âœ… Package created"
          ls -lh release/

      - name: ğŸ‰ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag_name.outputs.VERSION }}
          release_name: QuickShare ${{ steps.tag_name.outputs.VERSION }}
          body: |
            # ğŸš€ QuickShare QR Code Generator

            ## Release ${{ steps.tag_name.outputs.VERSION }}

            ### âœ¨ Features
            - âš¡ Instant QR Code Generation
            - ğŸ“² Multiple Quality Options (256px, 512px, 1024px)
            - ğŸ’¾ Smart Save with URL Display
            - âŒ¨ï¸ Keyboard Shortcuts Support
            - ğŸ¨ Beautiful Gradient Design
            - ğŸ”’ 100% Private & Offline
            - ğŸŒ Cross-browser Compatible

            ### ğŸ“¥ Installation
            1. Download the ZIP file below
            2. Extract to a folder
            3. Open your browser's extensions page
            4. Enable Developer Mode
            5. Click "Load unpacked" â†’ Select folder

            ### âŒ¨ï¸ Keyboard Shortcuts
            | Shortcut | Action |
            |----------|--------|
            | Ctrl+Shift+Q | Open QuickShare |
            | Ctrl+S | Save QR Code |
            | 1, 2, 3 | Select Quality |
            | â† â†’ | Navigate Options |
            | Enter | Save |
            | Escape | Close |

            ### ğŸ“ Recent Changes
            \`\`\`
            ${{ steps.changelog.outputs.CHANGELOG }}
            \`\`\`

            ### ğŸ“– Documentation
            - ğŸ“š [Full Documentation](https://github.com/anilkumarthakur60/browser-extension#readme)
            - âš™ï¸ [Quick Start Guide](https://github.com/anilkumarthakur60/browser-extension/blob/master/QUICKSTART.md)
            - ğŸ› [Report Issues](https://github.com/anilkumarthakur60/browser-extension/issues)

            ### ğŸ‘¨â€ğŸ’» Creator
            - ğŸ”— [GitHub Profile](https://github.com/anilkumarthakur60)
            - ğŸ‘¥ [Facebook](https://www.facebook.com/anilkumarthakur60)

            ---

            **Thank you for using QuickShare!** If you find it helpful, please consider giving it a â­

          draft: false
          prerelease: false

      - name: ğŸ“¤ Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release/quickshare-${{ steps.tag_name.outputs.VERSION }}.zip
          asset_name: quickshare-${{ steps.tag_name.outputs.VERSION }}.zip
          asset_content_type: application/zip

      - name: âœ… Release published successfully
        run: |
          echo "ğŸ‰ Release ${{ steps.tag_name.outputs.VERSION }} created!"
          echo "ğŸ“¦ Download: https://github.com/anilkumarthakur60/browser-extension/releases/tag/${{ steps.tag_name.outputs.VERSION }}"

  # ============================================
  # JOB 5: SUMMARY REPORT
  # ============================================
  summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š Pipeline Summary
    if: always()
    needs: [validate-extension, code-quality, security-checks]

    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "================================"
          echo "âœ… QuickShare CI/CD Pipeline"
          echo "================================"
          echo ""
          echo "ğŸ“‹ Validation: ${{ needs.validate-extension.result }}"
          echo "ğŸ” Code Quality: ${{ needs.code-quality.result }}"
          echo "ğŸ” Security: ${{ needs.security-checks.result }}"
          echo ""
          echo "âœ… All checks completed!"
          echo "================================"
