name: Validate Extension

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Extension Structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check manifest.json exists
        run: |
          if [ ! -f manifest.json ]; then
            echo "❌ manifest.json not found!"
            exit 1
          fi
          echo "✅ manifest.json found"

      - name: Validate manifest.json (JSON syntax)
        run: |
          python3 -m json.tool manifest.json > /dev/null
          echo "✅ manifest.json is valid JSON"

      - name: Check required files
        run: |
          required_files=("popup.html" "popup.js" "popup.css" "qrcode.min.js" "README.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file missing: $file"
              exit 1
            fi
            echo "✅ Found $file"
          done

      - name: Check required icons
        run: |
          icons=("icon16.png" "icon48.png" "icon128.png")
          for icon in "${icons[@]}"; do
            if [ ! -f "$icon" ]; then
              echo "❌ Required icon missing: $icon"
              exit 1
            fi
            echo "✅ Found $icon"
          done

      - name: Verify manifest references correct files
        run: |
          echo "✅ Checking manifest references..."
          if grep -q '"popup": "popup.html"' manifest.json || grep -q '"default_popup": "popup.html"' manifest.json; then
            echo "✅ popup.html referenced in manifest"
          else
            echo "⚠️ Warning: popup.html may not be referenced in manifest"
          fi

      - name: Check manifest version
        run: |
          version=$(python3 -c "import json; f=open('manifest.json'); d=json.load(f); print(d.get('version', 'NOT_FOUND'))")
          echo "✅ Manifest version: $version"
          if [ "$version" = "NOT_FOUND" ]; then
            echo "❌ Version not found in manifest"
            exit 1
          fi

      - name: Validation complete
        run: echo "✅ All validation checks passed!"
